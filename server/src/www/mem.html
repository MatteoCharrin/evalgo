<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mémoire — multi-agents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:canvas; color:canvastext; }
    .wrap { max-width:1100px; margin:0 auto; display:grid; gap:16px; }
    .card { padding:16px 20px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:16px; background:color-mix(in oklab, canvas 92%, canvastext 0%); box-shadow:0 1px 8px color-mix(in oklab, canvastext 10%, transparent); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    h2 { margin:0 0 10px; font-size:1.1rem; }
    .muted { opacity:.75; font-size:.9rem; }
    .row { display:grid; grid-template-columns: 150px 1fr 100px; gap:12px; align-items:center; margin:10px 0; }
    .label { font-weight:600; }
    .val { text-align:right; font-variant-numeric: tabular-nums; }
    .bar { height:18px; width:100%; border-radius:12px; overflow:hidden;
           background: color-mix(in oklab, canvas 85%, canvastext 0%);
           outline: 1px solid color-mix(in oklab, canvastext 15%, transparent); position:relative; }
    .fill { height:100%; width:0%; transition:width .35s ease; }
    .fill.ram  { background: linear-gradient(90deg, #37b24d, #1e90ff); }
    .fill.swap { background: linear-gradient(90deg, #f59f00, #ff6b6b); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:12px; }
    .kv { padding:10px 12px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:12px; background:color-mix(in oklab, canvas 96%, canvastext 0%); }
    .k { font-size:.85rem; opacity:.8; }
    .v { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>Mémoire — multi-agents</h1>
      <div class="muted">Source : <code>/api/memory</code></div>
    </section>

    <div id="root" class="wrap"></div>
  </div>

  <script>
    function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
    function fmtBytes(n){ n=Number(n)||0; const u=['B','KiB','MiB','GiB','TiB','PiB']; let i=0;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return (n<10? n.toFixed(2): n<100? n.toFixed(1): n.toFixed(0))+' '+u[i]; }
    function bar(pct, cls){ const p=Math.max(0,Math.min(100,Number(pct)||0));
      return '<div class="bar"><div class="fill '+cls+'" style="width:'+p.toFixed(2)+'%"></div></div>'; }
    function kv(k,v){ return '<div class="kv"><div class="k">'+esc(k)+'</div><div class="v">'+esc(v)+'</div></div>'; }

    function card(it){
      if(it.err){ return '<section class="card"><h2>'+esc(it.host)+' ('+esc(it.id)+')</h2><div class="muted">Erreur: '+esc(it.err)+'</div></section>'; }
      const m = it.data||{};
      const usedPercent = Number(m.usedPercent)||0;
      const swapTotal = Number(m.swapTotal)||0;
      const swapFree  = Number(m.swapFree)||0;
      const swapUsed  = swapTotal>0? (swapTotal-swapFree):0;
      const swapPct   = swapTotal>0? (swapUsed/swapTotal)*100:0;

      const summary = [
        ['RAM totale', fmtBytes(m.total)],
        ['RAM utilisée', fmtBytes(m.used)],
        ['RAM libre', fmtBytes(m.free)],
        ['RAM disponible', fmtBytes(m.available)],
        ['Cached', fmtBytes(m.cached)],
        ['Buffers', fmtBytes(m.buffers)],
        ['Active', fmtBytes(m.active)],
        ['Inactive', fmtBytes(m.inactive)],
        ['Slab', fmtBytes(m.slab)],
        ['Commit Limit', fmtBytes(m.commitLimit)],
        ['Committed AS', fmtBytes(m.committedAS)],
        ['Swap total', fmtBytes(m.swapTotal)],
        ['Swap libre', fmtBytes(m.swapFree)],
        ['Swap utilisée', fmtBytes(swapUsed)]
      ].map(([k,v])=>kv(k,v)).join('');

      return '<section class="card">'
        + '<h2>'+esc(it.host)+' ('+esc(it.id)+')</h2>'
        + '<div class="row"><div class="label">RAM utilisée</div>'+bar(usedPercent,'ram')+'<div class="val">'+usedPercent.toFixed(2)+'%</div></div>'
        + '<div class="row"><div class="label">SWAP utilisée</div>'+bar(swapPct,'swap')+'<div class="val">'+swapPct.toFixed(2)+'%</div></div>'
        + '<div class="grid" style="margin-top:10px">'+summary+'</div>'
        + '</section>';
    }

    async function load(){
      const root=document.getElementById('root');
      try{
        const res=await fetch('/api/memory');
        if(!res.ok) throw new Error('HTTP '+res.status);
        const all=await res.json();
        if(!Array.isArray(all)||!all.length){ root.innerHTML='<section class="card muted">Aucun agent</section>'; return; }
        root.innerHTML = all.map(card).join('');
      }catch(e){
        root.innerHTML = '<section class="card"><div class="muted">Erreur: '+esc(e.message)+'</div></section>';
      }
    }
    load(); setInterval(load, 2000);
  </script>
</body>
</html>
