<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Charge système — multi-agents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:canvas; color:canvastext; }
    .wrap { max-width:900px; margin:0 auto; display:grid; gap:16px; }
    .card { padding:16px 20px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:16px; background:color-mix(in oklab, canvas 92%, canvastext 0%); box-shadow:0 1px 8px color-mix(in oklab, canvastext 10%, transparent); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    h2 { margin:0 0 10px; font-size:1.05rem; }
    .muted { opacity:.75; font-size:.9rem; }
    .row { display:grid; grid-template-columns: 120px 1fr 80px; gap:12px; align-items:center; margin:10px 0; }
    .label { font-weight:600; }
    .val { text-align:right; font-variant-numeric: tabular-nums; }
    .bar { height:18px; width:100%; border-radius:12px; overflow:hidden; background: color-mix(in oklab, canvas 85%, canvastext 0%); outline: 1px solid color-mix(in oklab, canvastext 15%, transparent); position:relative; }
    .fill { height:100%; width:0%; transition:width .35s ease; }
    .fill.low { background: linear-gradient(90deg, #37b24d, #66d17a); }
    .fill.mid { background: linear-gradient(90deg, #f59f00, #ffd43b); }
    .fill.high{ background: linear-gradient(90deg, #e03131, #ff6b6b); }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>Charge système (load average) — multi-agents</h1>
      <div class="muted">Source : <code>/api/load</code></div>
    </section>

    <div id="root" class="wrap"></div>

    <section class="card" id="cpuLoadCard" style="display:none">
      <h2>Charge CPU par cœur — multi-agents</h2>
      <div class="muted">Source : <code>/api/cpuload</code> (optionnel)</div>
      <div id="cpuRoot" class="wrap"></div>
    </section>
  </div>

  <script>
    const SCALE_MAX = 4.0;
    function lvl(v){ const r = SCALE_MAX>0 ? v/SCALE_MAX : 0; return r<.5?'low': r<.8?'mid':'high'; }
    function bar(v){ const w=Math.max(0,Math.min(100,(v/SCALE_MAX)*100)); return '<div class="bar"><div class="fill '+lvl(v)+'" style="width:'+w.toFixed(0)+'%"></div></div>'; }
    function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}

    function loadCard(it){
      if(it.err) return '<section class="card"><h2>'+esc(it.host)+' ('+esc(it.id)+')</h2><div class="muted">Erreur: '+esc(it.err)+'</div></section>';
      const d = it.data||{};
      const l1=+d.load1||0, l5=+d.load5||0, l15=+d.load15||0;
      return '<section class="card"><h2>'+esc(it.host)+' ('+esc(it.id)+')</h2>'
        + '<div class="row"><div class="label">1 min</div>'+bar(l1)+'<div class="val mono">'+l1.toFixed(2)+'</div></div>'
        + '<div class="row"><div class="label">5 min</div>'+bar(l5)+'<div class="val mono">'+l5.toFixed(2)+'</div></div>'
        + '<div class="row"><div class="label">15 min</div>'+bar(l15)+'<div class="val mono">'+l15.toFixed(2)+'</div></div>'
        + '</section>';
    }

    function cpuRows(arr){
      if(!Array.isArray(arr)||!arr.length) return '<div class="muted">Aucun cœur</div>';
      const max = 1.0;
      return arr.map((v,i)=>{
        const w = Math.max(0,Math.min(100,(Number(v)||0)/max*100));
        const cl = (v<.5)?'low':(v<.8)?'mid':'high';
        return '<div class="row"><div class="label">CPU '+i+'</div>'
          + '<div class="bar"><div class="fill '+cl+'" style="width:'+w.toFixed(0)+'%"></div></div>'
          + '<div class="val mono">'+(Number(v)||0).toFixed(2)+'</div></div>';
      }).join('');
    }
    function cpuCard(it){
      if(it.err) return '<section class="card"><h2>'+esc(it.host)+' ('+esc(it.id)+')</h2><div class="muted">Erreur: '+esc(it.err)+'</div></section>';
      return '<section class="card"><h2>'+esc(it.host)+' ('+esc(it.id)+')</h2>'+cpuRows(it.data||[])+'</section>';
    }

    async function loadAll(){
      const root=document.getElementById('root');
      try{
        const res=await fetch('/api/load');
        if(!res.ok) throw new Error('HTTP '+res.status);
        const all=await res.json();
        root.innerHTML = Array.isArray(all)&&all.length ? all.map(loadCard).join('') : '<section class="card muted">Aucun agent</section>';
      }catch(e){ root.innerHTML = '<section class="card"><div class="muted">Erreur: '+esc(e.message)+'</div></section>'; }

      // Optionnel: /api/cpuload si exposé
      try{
        const res2 = await fetch('/api/cpuload', {cache:'no-store'});
        if(res2.ok){
          const all2 = await res2.json();
          document.getElementById('cpuRoot').innerHTML = Array.isArray(all2)&&all2.length ? all2.map(cpuCard).join('') : '<div class="muted">Aucune donnée</div>';
          document.getElementById('cpuLoadCard').style.display = 'block';
        } else {
          document.getElementById('cpuLoadCard').style.display = 'none';
        }
      }catch{ document.getElementById('cpuLoadCard').style.display = 'none'; }
    }
    loadAll(); setInterval(loadAll, 1000);
  </script>
</body>
</html>
